name: Raycast CI

on:
  pull_request:
  push:
    branches:
      - main

permissions: read-all

jobs:
  verify:
    runs-on: macos-latest
    timeout-minutes: 15
    env:
      # Keep npm cache inside the workspace (avoids permission issues).
      NPM_CONFIG_CACHE: .npm-cache
      # Pragmatic middle ground: pin migrations to avoid CI churn.
      # Bump intentionally when you bump @raycast/api.
      # Align with this repo's @raycast/api minor (currently 1.102.x).
      RAYCAST_MIGRATION_VERSION: "1.102.0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Verify Raycast Store metadata basics
        run: |
          node -e "const fs=require('fs'); const {execSync}=require('child_process'); const pkg=JSON.parse(fs.readFileSync('package.json','utf8')); if(pkg.license!=='MIT'){console.error('Expected package.json license to be MIT, got: '+pkg.license); process.exit(1);} if(!pkg.author||typeof pkg.author!=='string'||pkg.author.trim().length===0){console.error('Expected package.json author to be a non-empty string (your Raycast username).'); process.exit(1);} if(!fs.existsSync('package-lock.json')){console.error('Expected package-lock.json to exist (Raycast requires npm + lockfile).'); process.exit(1);} try{execSync('git ls-files --error-unmatch package-lock.json',{stdio:'ignore'});}catch{console.error('Expected package-lock.json to be committed (tracked by git).'); process.exit(1);} console.log('OK');"

      - name: Determine whether to run Raycast migrations
        id: migrations
        shell: bash
        run: |
          set -euo pipefail

          # Always run on pushes to main. For PRs, only run when dependency manifests changed.
          if [ "${GITHUB_EVENT_NAME}" != "pull_request" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          changed="$(git diff --name-only "origin/${GITHUB_BASE_REF}"...HEAD)"
          if echo "$changed" | grep -E '^(package\.json|package-lock\.json)$' >/dev/null; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure Raycast migrations are applied
        if: steps.migrations.outputs.run == 'true'
        run: |
          # @raycast/migration expects the extension path as its first argument.
          # Use an absolute path to avoid any arg-parsing edge cases in CI.
          npx -y "@raycast/migration@${RAYCAST_MIGRATION_VERSION}" "$GITHUB_WORKSPACE"

          if [ -n "$(git status --porcelain)" ]; then
            echo "Raycast migrations produced changes. Please run 'npx -y @raycast/migration@${RAYCAST_MIGRATION_VERSION} .' locally and commit the result."
            git status --porcelain
            git diff
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Raycast lint (Store requirement)
        run: npx ray lint

      - name: Raycast build export (Store requirement)
        run: npx ray build -e dist
